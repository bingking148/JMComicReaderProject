<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·²ä¸‹è½½æ¼«ç”» - JMæ¼«ç”»é˜…è¯»å™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>æˆ‘çš„ä¹¦æ¶</h1>
            <p>ç®¡ç†å’Œé˜…è¯»æ‚¨å·²ä¸‹è½½çš„æ¼«ç”»</p>
        </div>

        <!-- å·¥å…·æ  -->
        <div class="search-container">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md);">
                <button class="btn btn-secondary back-btn">è¿”å›é¦–é¡µ</button>
                
                <div style="display: flex; align-items: center; gap: var(--space-md);">
                    <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢å·²ä¸‹è½½çš„æ¼«ç”»..." style="width: 200px;">
                    <button id="refreshBtn" class="btn btn-primary">åˆ·æ–°</button>
                    <button id="cleanupBtn" class="btn btn-danger">æ¸…ç†ç¼“å­˜</button>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-container" style="background: var(--bg-secondary); padding: var(--space-xl); border-radius: var(--radius-lg); margin-bottom: var(--space-xl); box-shadow: var(--shadow-md); border: 1px solid var(--border-light);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-xl);">
                <div style="text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: bold; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="totalCount">0</div>
                    <div style="color: var(--text-secondary); margin-top: var(--space-xs);">æ€»æ¼«ç”»æ•°</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: bold; background: var(--secondary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="totalPages">0</div>
                    <div style="color: var(--text-secondary); margin-top: var(--space-xs);">æ€»é¡µæ•°</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: bold; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="totalSize">0</div>
                    <div style="color: var(--text-secondary); margin-top: var(--space-xs);">å ç”¨ç©ºé—´(MB)</div>
                </div>
            </div>
        </div>

        <!-- æ¼«ç”»åˆ—è¡¨ -->
        <div id="comicGrid" class="comic-grid">
            <!-- åŠ¨æ€åŠ è½½å·²ä¸‹è½½æ¼«ç”» -->
        </div>

        <!-- æ— ç»“æœæç¤º -->
        <div id="noResults" style="text-align: center; padding: 60px; display: none;">
            <div style="font-size: 4em; margin-bottom: 20px;">ğŸ“š</div>
            <h3>è¿˜æ²¡æœ‰ä¸‹è½½ä»»ä½•æ¼«ç”»</h3>
            <p>å»é¦–é¡µæœç´¢å¹¶ä¸‹è½½æ‚¨å–œæ¬¢çš„æ¼«ç”»å§ï¼</p>
            <button class="btn btn-primary" onclick="navigateTo('/')" style="margin-top: 20px;">å»é¦–é¡µ</button>
        </div>
    </div>

    <!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDeleteModal()">&times;</span>
            <h3>ğŸ—‘ï¸ ç¡®è®¤åˆ é™¤</h3>
            <p id="deleteMessage">ç¡®å®šè¦åˆ é™¤è¿™éƒ¨æ¼«ç”»å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ã€‚</p>
            <div style="text-align: center; margin-top: 20px;">
                <button id="confirmDeleteBtn" class="btn btn-danger">ç¡®è®¤åˆ é™¤</button>
                <button class="btn btn-secondary" onclick="closeDeleteModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        let downloadedComics = [];
        let filteredComics = [];
        let currentDeleteId = null;

        // åŠ è½½å·²ä¸‹è½½æ¼«ç”»åˆ—è¡¨
        async function loadDownloadedComics() {
            try {
                console.log('å¼€å§‹åŠ è½½å·²ä¸‹è½½æ¼«ç”»åˆ—è¡¨');
                
                const loadingDiv = showLoading(document.getElementById('comicGrid'));
                
                const comics = await apiRequest(`/api/downloaded`);
                
                console.log('è·å–åˆ°å·²ä¸‹è½½æ¼«ç”»:', comics);
                
                hideLoading(loadingDiv);
                
                downloadedComics = comics;
                filteredComics = [...comics];
                
                displayDownloadedComics();
                updateStatistics();
                
                if (comics.length === 0) {
                    console.log('æ²¡æœ‰å·²ä¸‹è½½çš„æ¼«ç”»');
                    document.getElementById('noResults').style.display = 'block';
                } else {
                    console.log(`æ˜¾ç¤º ${comics.length} éƒ¨å·²ä¸‹è½½çš„æ¼«ç”»`);
                    document.getElementById('noResults').style.display = 'none';
                }
                
            } catch (error) {
                console.error('åŠ è½½å·²ä¸‹è½½æ¼«ç”»å¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                
                hideLoading(document.querySelector('.loading-container'));
                showMessage('åŠ è½½å¤±è´¥: ' + error.message, 'error');
                
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                document.getElementById('comicGrid').innerHTML = `
                    <div class="error-container">
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                        <details>
                            <summary>è¯¦ç»†é”™è¯¯ä¿¡æ¯</summary>
                            <pre>${error.stack}</pre>
                        </details>
                        <button class="btn btn-primary" onclick="loadDownloadedComics()" style="margin-top: 10px;">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºå·²ä¸‹è½½æ¼«ç”»
        function displayDownloadedComics() {
            const grid = document.getElementById('comicGrid');
            grid.innerHTML = '';
            
            if (filteredComics.length === 0) {
                document.getElementById('noResults').style.display = 'block';
                return;
            }
            
            document.getElementById('noResults').style.display = 'none';
            
            filteredComics.forEach(comic => {
                const comicCard = createDownloadedComicCard(comic);
                grid.appendChild(comicCard);
            });
        }

        // åˆ›å»ºå·²ä¸‹è½½æ¼«ç”»å¡ç‰‡
        function createDownloadedComicCard(comic) {
            const card = document.createElement('div');
            card.className = 'comic-card';
            
            // ä½¿ç”¨æ–°çš„APIç«¯ç‚¹è·å–å·²ä¸‹è½½æ¼«ç”»çš„å°é¢
            const coverUrl = comic.cover_path ? `/api/cover/downloaded/${comic.id}` : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI4MCIgdmlld0JveD0iMCAwIDIwMCAyODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjgwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTQwIiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1zaXplPSIxNCI+5Zu+54mH5Yqg6L295aSx6LSlPC90ZXh0Pgo8L3N2Zz4K';
            const title = comic.title || 'æœªçŸ¥æ ‡é¢˜';
            const author = comic.author || 'æœªçŸ¥ä½œè€…';
            const pages = comic.pages || 0;
            const favorites = formatNumber(comic.favorites || 0);
            const downloadTime = formatTime(comic.download_time);
            const lastReadTime = comic.last_read_time ? formatTime(comic.last_read_time) : 'æœªé˜…è¯»';
            const readProgress = comic.read_progress || 0;
            
            card.innerHTML = `
                <img src="${coverUrl}" alt="${title}" class="comic-cover" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI4MCIgdmlld0JveD0iMCAwIDIwMCAyODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjgwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTQwIiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1zaXplPSIxNCI+5Zu+54mH5Yqg6L295aSx6LSlPC90ZXh0Pgo8L3N2Zz4K'">
                <div class="comic-info">
                    <div class="comic-title" title="${title}">${title}</div>
                    <div style="color: #666; font-size: 0.9em; margin-bottom: 8px;">
                        <div>ä½œè€…: ${author}</div>
                        <div>é¡µæ•°: ${pages} é¡µ</div>
                        <div>æ”¶è—: ${favorites}</div>
                    </div>
                    <div style="color: #888; font-size: 0.8em; margin-bottom: 10px;">
                        <div>ä¸‹è½½æ—¶é—´: ${downloadTime}</div>
                        <div>æœ€åé˜…è¯»: ${lastReadTime}</div>
                        ${readProgress > 0 ? `<div>é˜…è¯»è¿›åº¦: ${readProgress} é¡µ</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); startReading(${comic.id})" style="flex: 1; padding: 8px;">
                            ğŸ“– é˜…è¯»
                        </button>
                        <button class="btn btn-danger" onclick="event.stopPropagation(); showDeleteConfirm(${comic.id}, '${title}')" style="padding: 8px 12px;">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics() {
            const totalCount = downloadedComics.length;
            const totalPages = downloadedComics.reduce((sum, comic) => sum + (comic.pages || 0), 0);
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('totalPages').textContent = totalPages;
            
            // è®¡ç®—æ€»å¤§å°ï¼ˆä½¿ç”¨çœŸå®çš„file_sizeï¼‰
            const totalSize = downloadedComics.reduce((sum, comic) => sum + (comic.file_size || 0), 0);
            const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(1);
            document.getElementById('totalSize').textContent = totalSizeMB;
        }

        // æœç´¢åŠŸèƒ½
        function searchComics() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredComics = [...downloadedComics];
            } else {
                filteredComics = downloadedComics.filter(comic => {
                    const title = (comic.title || '').toLowerCase();
                    const author = (comic.author || '').toLowerCase();
                    const tags = (comic.tags || []).join(' ').toLowerCase();
                    
                    return title.includes(searchTerm) || 
                           author.includes(searchTerm) || 
                           tags.includes(searchTerm);
                });
            }
            
            displayDownloadedComics();
        }

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤
        function showDeleteConfirm(jmId, title) {
            currentDeleteId = jmId;
            document.getElementById('deleteMessage').textContent = `ç¡®å®šè¦åˆ é™¤ã€Š${title}ã€‹å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ã€‚`;
            document.getElementById('deleteModal').style.display = 'block';
        }

        // å…³é—­åˆ é™¤ç¡®è®¤
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            currentDeleteId = null;
        }

        // ç¡®è®¤åˆ é™¤
        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            if (currentDeleteId) {
                await deleteComic(currentDeleteId);
                closeDeleteModal();
            }
        });

        // æ¸…ç†ç¼“å­˜
        async function cleanupCache() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶ä½†ä¿ç•™å·²ä¸‹è½½çš„æ¼«ç”»ã€‚')) {
                return;
            }
            
            try {
                showMessage('ç¼“å­˜æ¸…ç†åŠŸèƒ½å¼€å‘ä¸­...', 'info');
            } catch (error) {
                showMessage('æ¸…ç†ç¼“å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // æœç´¢è¾“å…¥æ¡†
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', debounce(searchComics, 300));
            
            // åˆ·æ–°æŒ‰é’®
            document.getElementById('refreshBtn').addEventListener('click', loadDownloadedComics);
            
            // æ¸…ç†ç¼“å­˜æŒ‰é’®
            document.getElementById('cleanupBtn').addEventListener('click', cleanupCache);
            
            // åŠ è½½æ¼«ç”»åˆ—è¡¨
            loadDownloadedComics();
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('deleteModal');
            if (event.target == modal) {
                closeDeleteModal();
            }
        }
    </script>
</body>
</html>