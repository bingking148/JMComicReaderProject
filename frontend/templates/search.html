<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœç´¢ç»“æœ - JMæ¼«ç”»é˜…è¯»å™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>æœç´¢ç»“æœ</h1>
            <p>å…³é”®è¯ <strong id="searchKeyword">{{ keyword }}</strong></p>
        </div>
        
        <!-- å·¥å…·æ  -->
        <div class="search-container">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md);">
                <button class="btn btn-secondary back-btn">è¿”å›é¦–é¡µ</button>
                
                <div style="display: flex; align-items: center; gap: var(--space-md);">
                    <span style="color: var(--text-secondary);">æ’åº</span>
                    <select id="sortSelect" class="search-input" style="width: auto; min-width: 120px;">
                        <option value="desc">æ”¶è—é‡ é™åº</option>
                        <option value="asc">æ”¶è—é‡ å‡åº</option>
                    </select>
                    <button id="refreshBtn" class="btn btn-primary">åˆ·æ–°</button>
                </div>
            </div>
        </div>
        
        <!-- ç»“æœç»Ÿè®¡ -->
        <div class="search-stats" style="background: var(--bg-secondary); padding: var(--space-lg); border-radius: var(--radius-md); margin-bottom: var(--space-xl); box-shadow: var(--shadow-sm); border: 1px solid var(--border-light);">
            <p style="margin: 0; color: var(--text-secondary);">æ‰¾åˆ° <strong id="resultCount" style="color: var(--text-primary);">0</strong> ä¸ªç›¸å…³ç»“æœ</p>
        </div>
        
        <!-- æ¼«ç”»åˆ—è¡¨ -->
        <div id="comicGrid" class="comic-grid">
            <!-- åŠ¨æ€åŠ è½½æœç´¢ç»“æœ -->
        </div>
        
        <!-- åŠ è½½æ›´å¤š -->
        <div id="loadMore" style="text-align: center; margin: 30px 0; display: none;">
            <button class="btn btn-primary" onclick="loadMoreResults()">åŠ è½½æ›´å¤š</button>
        </div>
        
        <!-- æ— ç»“æœæç¤º -->
        <div id="noResults" style="text-align: center; padding: 60px; display: none;">
            <div style="font-size: 4em; margin-bottom: 20px;">ğŸ˜”</div>
            <h3>æœªæ‰¾åˆ°ç›¸å…³æ¼«ç”»</h3>
            <p>è¯•è¯•å…¶ä»–å…³é”®è¯å§</p>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // è·å–URLå‚æ•°
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        // è·å–å…³é”®è¯
        const keyword = getUrlParameter('keyword');
        let currentPage = 1;
        let currentSort = 'desc';
        let isLoading = false;
        let hasMore = true;
        
        // æ›´æ–°é¡µé¢æ ‡é¢˜
        document.getElementById('searchKeyword').textContent = keyword || 'æœªçŸ¥';
        
        // åŠ è½½æœç´¢ç»“æœ
        async function loadSearchResults(page = 1, sort = 'desc', append = false) {
            if (isLoading || !hasMore) return;
            
            isLoading = true;
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const loadingDiv = showLoading(document.getElementById('comicGrid'));
            
            try {
                 const results = await apiRequest(`/api/search/keyword?keyword=${encodeURIComponent(keyword)}&sort=${sort}`);
                console.log('æœç´¢APIè¿”å›ç»“æœ:', results);
                console.log('ç»“æœæ•°é‡:', results ? results.length : 0);
                if (results && results.length > 0) {
                    console.log('ç¬¬ä¸€ä¸ªç»“æœ:', results[0]);
                }
                
                hideLoading(loadingDiv);
                
                if (results && results.length > 0) {
                    displaySearchResults(results, append);
                    
                    // æ›´æ–°ç»“æœè®¡æ•°
                    const currentCount = document.querySelectorAll('.comic-card').length;
                    document.getElementById('resultCount').textContent = currentCount;
                    
                    // æ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
                    if (results.length >= 20) { // å‡è®¾æ¯é¡µ20ä¸ªç»“æœ
                        document.getElementById('loadMore').style.display = 'block';
                    } else {
                        hasMore = false;
                    }
                    
                    // éšè—æ— ç»“æœæç¤º
                    document.getElementById('noResults').style.display = 'none';
                } else {
                    if (!append) {
                        // æ²¡æœ‰ç»“æœ
                        document.getElementById('noResults').style.display = 'block';
                        document.getElementById('loadMore').style.display = 'none';
                    }
                    hasMore = false;
                }
                
            } catch (error) {
                hideLoading(loadingDiv);
                showMessage('æœç´¢å¤±è´¥: ' + error.message, 'error');
            } finally {
                isLoading = false;
            }
        }
        
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(comics, append = false) {
            const grid = document.getElementById('comicGrid');
            
            if (!append) {
                grid.innerHTML = '';
            }
            
            comics.forEach(comic => {
                const comicCard = createComicCard(comic);
                grid.appendChild(comicCard);
            });
        }
        
        // åˆ›å»ºæ¼«ç”»å¡ç‰‡ï¼ˆå¸¦å°é¢æ‡’åŠ è½½ï¼‰
        function createComicCard(comic) {
            const card = document.createElement('div');
            card.className = 'comic-card';
            card.onclick = () => navigateTo(`/detail/${comic.id}`);
            
            const title = comic.title || 'æœªçŸ¥æ ‡é¢˜';
            const favorites = formatNumber(comic.favorites || 0);
            const tags = comic.tags ? comic.tags.slice(0, 3).join(', ') : 'æ— æ ‡ç­¾';
            
            // ä½¿ç”¨å ä½å›¾ï¼Œç¨åæ‡’åŠ è½½çœŸå®å°é¢
            const placeholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI4MCIgdmlld0JveD0iMCAwIDIwMCAyODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjgwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTQwIiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1zaXplPSIxNCI+5Zu+54mH5Yqg6L295aSx6LSlPC90ZXh0Pgo8L3N2Zz4K';
            
            card.innerHTML = `
                <img src="${placeholder}" alt="${title}" class="comic-cover" data-jm-id="${comic.id}" data-loaded="false">
                <div class="comic-info">
                    <div class="comic-title" title="${title}">${title}</div>
                    <div class="comic-meta">
                        <span>â¤ï¸ ${favorites}</span>
                        <span>JM-${comic.id}</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8em; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${tags}
                    </div>
                </div>
            `;
            
            // æ ‡è®°éœ€è¦æ‡’åŠ è½½å°é¢
            card.dataset.needsCover = comic.needs_cover ? "true" : "false";
            card.dataset.jmId = comic.id;
            
            return card;
        }
        
        // åŠ è½½æ›´å¤šç»“æœ
        function loadMoreResults() {
            currentPage++;
            loadSearchResults(currentPage, currentSort, true);
        }
        
        // æ’åºå˜åŒ–
        document.getElementById('sortSelect').addEventListener('change', function() {
            currentSort = this.value;
            currentPage = 1;
            hasMore = true;
            loadSearchResults(currentPage, currentSort, false);
        });
        
        // åˆ·æ–°æŒ‰é’®
        document.getElementById('refreshBtn').addEventListener('click', function() {
            currentPage = 1;
            hasMore = true;
            loadSearchResults(currentPage, currentSort, false);
        });
        
        // å°é¢æ‡’åŠ è½½
        async function lazyLoadCovers() {
            const comicCards = document.querySelectorAll('.comic-card[data-needs-cover="true"]');
            console.log(`éœ€è¦æ‡’åŠ è½½å°é¢çš„å¡ç‰‡æ•°é‡: ${comicCards.length}`);
            
            // æ¯æ¬¡åŠ è½½3ä¸ªå°é¢ï¼Œé¿å…åŒæ—¶å‘èµ·å¤ªå¤šè¯·æ±‚
            const batchSize = 3;
            for (let i = 0; i < comicCards.length; i += batchSize) {
                const batch = Array.from(comicCards).slice(i, i + batchSize);
                
                // å¹¶è¡ŒåŠ è½½å½“å‰æ‰¹æ¬¡çš„å°é¢
                const promises = batch.map(card => loadCoverForCard(card));
                await Promise.all(promises);
                
                // çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è¯·æ±‚è¿‡äºå¯†é›†
                if (i + batchSize < comicCards.length) {
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }
        }
        
        // ä¸ºå•ä¸ªå¡ç‰‡åŠ è½½å°é¢
        async function loadCoverForCard(card) {
            const jmId = card.dataset.jmId;
            if (!jmId) return;
            
            try {
                console.log(`åŠ è½½å°é¢ JM-${jmId}`);
                const response = await fetch(`/api/cover/${jmId}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.cover) {
                    const img = card.querySelector('.comic-cover');
                    if (img) {
                        img.src = data.data.cover;
                        img.dataset.loaded = "true";
                        card.dataset.needsCover = "false";
                        console.log(`å°é¢åŠ è½½æˆåŠŸ JM-${jmId}`);
                    }
                } else {
                    console.log(`å°é¢æœªæ‰¾åˆ° JM-${jmId}`);
                }
            } catch (error) {
                console.error(`å°é¢åŠ è½½å¤±è´¥ JM-${jmId}:`, error);
            }
        }
        
        // è§‚å¯Ÿè€…APIå®ç°æ»šåŠ¨æ‡’åŠ è½½
        function setupIntersectionObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const card = entry.target;
                        if (card.dataset.needsCover === "true") {
                            loadCoverForCard(card);
                        }
                        observer.unobserve(card);
                    }
                });
            }, {
                rootMargin: '50px', // æå‰50pxå¼€å§‹åŠ è½½
                threshold: 0.1
            });
            
            // è§‚å¯Ÿæ‰€æœ‰éœ€è¦å°é¢çš„å¡ç‰‡
            document.querySelectorAll('.comic-card[data-needs-cover="true"]').forEach(card => {
                observer.observe(card);
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            if (keyword) {
                loadSearchResults().then(() => {
                    // æœç´¢ç»“æœåŠ è½½å®Œæˆåï¼Œå¼€å§‹æ‡’åŠ è½½å°é¢
                    console.log('å¼€å§‹æ‡’åŠ è½½å°é¢...');
                    
                    // æ–¹æ³•1ï¼šä½¿ç”¨è§‚å¯Ÿè€…APIï¼ˆæ»šåŠ¨æ—¶åŠ è½½ï¼‰
                    if ('IntersectionObserver' in window) {
                        setupIntersectionObserver();
                        console.log('ä½¿ç”¨IntersectionObserverè¿›è¡Œæ»šåŠ¨æ‡’åŠ è½½');
                    } 
                    // æ–¹æ³•2ï¼šæ‰¹é‡å»¶è¿ŸåŠ è½½ï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
                    else {
                        setTimeout(lazyLoadCovers, 1000);
                        console.log('ä½¿ç”¨æ‰¹é‡å»¶è¿ŸåŠ è½½');
                    }
                });
            } else {
                showMessage('æ²¡æœ‰æœç´¢å…³é”®è¯', 'warning');
                document.getElementById('noResults').style.display = 'block';
            }
        });
    </script>
</body>
</html>
