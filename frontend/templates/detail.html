<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼«ç”»è¯¦æƒ… - JMæ¼«ç”»é˜…è¯»å™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .detail-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-2xl);
            margin-bottom: var(--space-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
        }
        
        .detail-header {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: var(--space-2xl);
            margin-bottom: var(--space-2xl);
            align-items: start;
        }
        
        .detail-cover {
            width: 100%;
            height: 420px;
            object-fit: cover;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            transition: transform 0.3s ease;
        }
        
        .detail-cover:hover {
            transform: scale(1.02);
        }
        
        .detail-info h2 {
            font-size: 2.25rem;
            margin-bottom: var(--space-lg);
            color: var(--text-primary);
            font-weight: 700;
            line-height: 1.3;
        }
        
        .detail-meta {
            margin-bottom: var(--space-lg);
            background: var(--bg-tertiary);
            padding: var(--space-lg);
            border-radius: var(--radius-md);
        }
        
        .detail-meta-item {
            display: flex;
            margin-bottom: var(--space-sm);
            align-items: center;
        }
        
        .detail-meta-label {
            font-weight: 600;
            min-width: 100px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .detail-meta-value {
            flex: 1;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
            margin-top: var(--space-xs);
        }
        
        .tag {
            background: var(--primary-gradient);
            color: white;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 500;
            box-shadow: var(--shadow-sm);
        }
        
        .action-buttons {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-lg);
            flex-wrap: wrap;
        }
        
        .description-section {
            margin-top: var(--space-2xl);
            background: var(--bg-tertiary);
            padding: var(--space-xl);
            border-radius: var(--radius-md);
        }
        
        .description-section h3 {
            margin-bottom: var(--space-md);
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 600;
            border-bottom: 2px solid transparent;
            background: var(--primary-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            padding-bottom: var(--space-sm);
        }
        
        .description-content {
            line-height: 1.8;
            color: var(--text-secondary);
            white-space: pre-wrap;
            font-size: 1rem;
        }
        
        .download-progress {
            margin-top: var(--space-xl);
            padding: var(--space-xl);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            display: none;
            border: 1px solid var(--border-light);
        }
        
        .download-progress h4 {
            margin-bottom: var(--space-md);
            color: var(--text-primary);
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .detail-container {
                padding: var(--space-lg);
            }
            
            .detail-header {
                grid-template-columns: 1fr;
                gap: var(--space-lg);
                text-align: center;
            }
            
            .detail-cover {
                max-width: 280px;
                margin: 0 auto;
                height: 380px;
            }
            
            .detail-info h2 {
                font-size: 1.75rem;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>æ¼«ç”»è¯¦æƒ…</h1>
            <p>JMå· <strong>{{ jm_id }}</strong></p>
        </div>

        <!-- å·¥å…·æ  -->
        <div class="search-container">
            <button class="btn btn-secondary back-btn">â† è¿”å›</button>
        </div>

        <!-- è¯¦æƒ…å†…å®¹ -->
        <div id="detailContainer" class="detail-container">
            <div class="loading-container">
                <div class="loading"></div>
                <p>æ­£åœ¨åŠ è½½æ¼«ç”»ä¿¡æ¯...</p>
            </div>
        </div>

        <!-- ä¸‹è½½è¿›åº¦ -->
        <div id="downloadProgress" class="download-progress">
            <h4>ğŸ“¥ ä¸‹è½½è¿›åº¦</h4>
            <div class="progress-container">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <p id="progressText" class="progress-text">å‡†å¤‡ä¸‹è½½...</p>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        const jmId = {{ jm_id }};
        let comicInfo = null;
        let downloadId = null;
        let isDownloaded = false;

        // åŠ è½½æ¼«ç”»è¯¦æƒ…
        async function loadComicDetail() {
            try {
                const comic = await apiRequest(`${API_BASE_URL}/search/jm/${jmId}`);
                comicInfo = comic;
                displayComicDetail(comic);
                
                // æ£€æŸ¥æ˜¯å¦å·²ä¸‹è½½
                await checkDownloadStatus();
                
            } catch (error) {
                showMessage('åŠ è½½æ¼«ç”»ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
                document.getElementById('detailContainer').innerHTML = `
                    <div style="text-align: center; padding: 60px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">ğŸ˜”</div>
                        <h3>æœªæ‰¾åˆ°è¯¥æ¼«ç”»</h3>
                        <p>å¯èƒ½æ˜¯JMå·é”™è¯¯æˆ–æ¼«ç”»ä¸å­˜åœ¨</p>
                        <button class="btn btn-primary" onclick="goBack()" style="margin-top: 20px;">è¿”å›</button>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºæ¼«ç”»è¯¦æƒ…
        function displayComicDetail(comic) {
            const container = document.getElementById('detailContainer');
            
            const coverUrl = comic.cover || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDMwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjAwIiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1zaXplPSIxOCI+5Zu+54mH5Yqg6L295aSx6LSlPC90ZXh0Pgo8L3N2Zz4K';
            const title = comic.title || 'æœªçŸ¥æ ‡é¢˜';
            const author = comic.author || 'æœªçŸ¥ä½œè€…';
            const favorites = formatNumber(comic.favorites || 0);
            const pages = comic.pages || 0;
            const tags = comic.tags || [];
            const description = comic.description || 'æš‚æ— ç®€ä»‹';
            
            container.innerHTML = `
                <div class="detail-header">
                    <div>
                        <img src="${coverUrl}" alt="${title}" class="detail-cover" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDMwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjAwIiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1zaXplPSIxOCI+5Zu+54mH5Yqg6L295aSx6LSlPC90ZXh0Pgo8L3N2Zz4K'">
                    </div>
                    <div class="detail-info">
                        <h2>${title}</h2>
                        <div class="detail-meta">
                            <div class="detail-meta-item">
                                <span class="detail-meta-label">JMå·ï¼š</span>
                                <span class="detail-meta-value">${comic.id}</span>
                            </div>
                            <div class="detail-meta-item">
                                <span class="detail-meta-label">ä½œè€…ï¼š</span>
                                <span class="detail-meta-value">${author}</span>
                            </div>
                            <div class="detail-meta-item">
                                <span class="detail-meta-label">æ”¶è—é‡ï¼š</span>
                                <span class="detail-meta-value">â¤ï¸ ${favorites}</span>
                            </div>
                            <div class="detail-meta-item">
                                <span class="detail-meta-label">é¡µæ•°ï¼š</span>
                                <span class="detail-meta-value">${pages} é¡µ</span>
                            </div>
                            <div class="detail-meta-item">
                                <span class="detail-meta-label">æ ‡ç­¾ï¼š</span>
                                <div class="detail-meta-value">
                                    <div class="tags-container">
                                        ${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="action-buttons" id="actionButtons">
                            <button class="btn btn-primary" onclick="downloadComic(${comic.id})">ğŸ“¥ å¼€å§‹ä¸‹è½½</button>
                        </div>
                    </div>
                </div>
                
                <div class="description-section">
                    <h3>ğŸ“– ç®€ä»‹</h3>
                    <div class="description-content">${description}</div>
                </div>
            `;
        }

        // æ£€æŸ¥ä¸‹è½½çŠ¶æ€
        async function checkDownloadStatus() {
            try {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯APIæ£€æŸ¥æ˜¯å¦å·²ä¸‹è½½
                // ç°åœ¨æ¨¡æ‹Ÿæ£€æŸ¥
                isDownloaded = false; // é»˜è®¤æœªä¸‹è½½
                updateActionButtons();
                
            } catch (error) {
                console.error('æ£€æŸ¥ä¸‹è½½çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æ“ä½œæŒ‰é’®
        function updateActionButtons() {
            const buttonsContainer = document.getElementById('actionButtons');
            if (!buttonsContainer) return;
            
            if (isDownloaded) {
                buttonsContainer.innerHTML = `
                    <button class="btn btn-primary" onclick="startReading(${jmId})">ğŸ“– å·²ä¸‹è½½ï¼Œå‰å¾€é˜…è¯»</button>
                    <button class="btn btn-secondary" onclick="showReDownloadConfirm()">ğŸ”„ é‡æ–°ä¸‹è½½</button>
                `;
            } else {
                buttonsContainer.innerHTML = `
                    <button class="btn btn-primary" onclick="downloadComic(${jmId})">ğŸ“¥ å¼€å§‹ä¸‹è½½</button>
                `;
            }
        }

        // æ˜¾ç¤ºé‡æ–°ä¸‹è½½ç¡®è®¤
        function showReDownloadConfirm() {
            if (confirm('è¯¥æ¼«ç”»å·²ä¸‹è½½ï¼Œæ˜¯å¦é‡æ–°ä¸‹è½½ï¼Ÿé‡æ–°ä¸‹è½½å°†è¦†ç›–åŸæ–‡ä»¶ã€‚')) {
                downloadComic(jmId);
            }
        }

        // ä¸‹è½½æ¼«ç”»ï¼ˆé‡å†™ä»¥æ”¯æŒè¿›åº¦æ˜¾ç¤ºï¼‰
        async function downloadComic(jmId) {
            try {
                showMessage('å¼€å§‹ä¸‹è½½ï¼Œè¯·ç¨å€™...', 'info');
                
                // æ˜¾ç¤ºä¸‹è½½è¿›åº¦åŒºåŸŸ
                document.getElementById('downloadProgress').style.display = 'block';
                
                const response = await fetch(`${API_BASE_URL}/download/${jmId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('ä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨', 'success');
                    downloadId = data.download_id;
                    
                    // å¼€å§‹ç›‘æ§ä¸‹è½½è¿›åº¦
                    monitorDownloadProgressForDetail(data.download_id);
                } else {
                    if (data.downloaded) {
                        showReDownloadConfirm();
                    } else {
                        showMessage(data.message, 'error');
                    }
                }
            } catch (error) {
                showMessage('ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç›‘æ§ä¸‹è½½è¿›åº¦ï¼ˆè¯¦æƒ…é¡µä¸“ç”¨ï¼‰
        function monitorDownloadProgressForDetail(downloadId) {
            const progressInterval = setInterval(async () => {
                try {
                    const progress = await apiRequest(`${API_BASE_URL}/download/progress/${downloadId}`);
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    
                    if (progressBar) {
                        progressBar.style.width = progress.progress + '%';
                    }
                    
                    if (progressText) {
                        progressText.textContent = progress.message;
                    }
                    
                    if (progress.status === 'completed') {
                        showMessage('ä¸‹è½½å®Œæˆï¼', 'success');
                        clearInterval(progressInterval);
                        isDownloaded = true;
                        updateActionButtons();
                        
                        // 3ç§’åéšè—è¿›åº¦æ¡
                        setTimeout(() => {
                            document.getElementById('downloadProgress').style.display = 'none';
                        }, 3000);
                    } else if (progress.status === 'error') {
                        showMessage('ä¸‹è½½å¤±è´¥: ' + progress.message, 'error');
                        clearInterval(progressInterval);
                    }
                } catch (error) {
                    console.error('è·å–ä¸‹è½½è¿›åº¦å¤±è´¥:', error);
                    clearInterval(progressInterval);
                }
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadComicDetail();
        });
    </script>
</body>
</html>