<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JMæ¼«ç”»é˜…è¯»å™¨ - é¦–é¡µ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>JMæ¼«ç”»é˜…è¯»å™¨</h1>
            <p>ä¸“ä¸šçš„æ¼«ç”»ç®¡ç†ä¸é˜…è¯»å¹³å°ï¼Œä¸ºæ‚¨æä¾›æè‡´çš„é˜…è¯»ä½“éªŒ</p>
        </div>
        
        <!-- æœç´¢åŒºåŸŸ -->
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="è¾“å…¥JMå·æˆ–å…³é”®è¯æœç´¢æ¼«ç”»..." maxlength="100">
                <button id="searchBtn" class="search-btn">æœç´¢</button>
            </div>
            <div class="search-tips">
                ğŸ’¡ æ”¯æŒJMå·ç²¾å‡†æœç´¢å’Œå…³é”®è¯æ¨¡ç³Šæœç´¢
            </div>
        </div>
        
        <!-- åŠŸèƒ½å…¥å£ -->
        <div class="feature-buttons">
            <div class="feature-card" onclick="navigateTo('/downloaded')">
                <div class="feature-icon">ğŸ“š</div>
                <h3>æˆ‘çš„ä¹¦æ¶</h3>
                <p>ç®¡ç†å·²ä¸‹è½½çš„æ¼«ç”»ï¼Œéšæ—¶å¼€å§‹é˜…è¯»</p>
            </div>
            <div class="feature-card" onclick="showCacheStatus()">
                <div class="feature-icon">âš¡</div>
                <h3>ç³»ç»Ÿä¼˜åŒ–</h3>
                <p>æ™ºèƒ½æ¸…ç†ç¼“å­˜ï¼Œä¿æŒæœ€ä½³æ€§èƒ½</p>
            </div>
            <div class="feature-card" onclick="showAbout()">
                <div class="feature-icon">â“</div>
                <h3>å¸®åŠ©ä¸­å¿ƒ</h3>
                <p>äº†è§£åŠŸèƒ½è¯¦æƒ…ï¼Œè·å–ä½¿ç”¨æŒ‡å—</p>
            </div>
        </div>
        
        <!-- æœ€è¿‘æœç´¢ -->
        <div class="recent-searches" style="display: none;">
            <h3>æœ€è¿‘æœç´¢</h3>
            <div class="comic-grid" id="recentGrid">
                <!-- åŠ¨æ€åŠ è½½æœ€è¿‘æœç´¢è®°å½• -->
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // æœç´¢æŒ‰é’®ç‚¹å‡»
        document.getElementById('searchBtn').addEventListener('click', function() {
            const keyword = document.getElementById('searchInput').value.trim();
            
            // åˆ¤æ–­æ˜¯JMå·è¿˜æ˜¯å…³é”®è¯
            if (/^\d+$/.test(keyword)) {
                // çº¯æ•°å­—ï¼Œè·³è½¬åˆ°è¯¦æƒ…é¡µ
                navigateTo(`/detail/${keyword}`);
            } else if (keyword) {
                // å…³é”®è¯ï¼Œè·³è½¬åˆ°æœç´¢é¡µ
                navigateTo(`/search?keyword=${encodeURIComponent(keyword)}`);
            } else {
                showMessage('è¯·è¾“å…¥æœç´¢å†…å®¹', 'warning');
            }
        });

        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        // æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
        async function showCacheStatus() {
            try {
                // ä¿®å¤ï¼šapiRequestç›´æ¥è¿”å›dataï¼Œä¸éœ€è¦å†è®¿é—®.result.data
                const status = await apiRequest('/api/cache/status');
                
                // æ·»åŠ é˜²å¾¡æ€§æ£€æŸ¥ï¼Œé˜²æ­¢undefinedè®¿é—®
                const cacheSize = status?.cache_size_mb || 0;
                const needCleanup = status?.need_cleanup || false;
                
                const message = `
                    <div class="modal" style="display: block;">
                        <div class="modal-content">
                            <h3>ç¼“å­˜çŠ¶æ€</h3>
                            <p>ç¼“å­˜å¤§å°: ${cacheSize} MB</p>
                            <p>${needCleanup ? 'éœ€è¦æ¸…ç†' : 'ç¼“å­˜æ­£å¸¸'}</p>
                            <button class="btn btn-primary" onclick="this.closest('.modal').style.display='none'">å…³é—­</button>
                            ${needCleanup ? '<button class="btn btn-danger" onclick="clearCache(); this.closest(\'.modal\').style.display=\'none\'">æ¸…ç†ç¼“å­˜</button>' : ''}
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', message);
            } catch (error) {
                console.error('è·å–ç¼“å­˜çŠ¶æ€å¤±è´¥:', error);
                showMessage('è·å–ç¼“å­˜çŠ¶æ€å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        }

        // æ¸…ç†ç¼“å­˜
        async function clearCache() {
            try {
                // ä¿®å¤ï¼šapiRequestç›´æ¥è¿”å›dataï¼Œä¸éœ€è¦å†æ£€æŸ¥success
                const result = await apiRequest('/api/cache/clear', { method: 'POST' });
                showMessage(`æ¸…ç†æˆåŠŸï¼š${result.cleared_size_mb || 0} MB`, 'success');
            } catch (error) {
                console.error('æ¸…ç†ç¼“å­˜å¤±è´¥:', error);
                showMessage('æ¸…ç†ç¼“å­˜å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        }

        // æ˜¾ç¤ºå…³äº
        function showAbout() {
            const message = `
                <div class="modal" style="display: block;">
                    <div class="modal-content">
                        <h3>JMæ¼«ç”»é˜…è¯»å™¨</h3>
                        <p>å®Œæ•´çš„JMæ¼«ç”»æŸ¥æ‰¾ã€å±•ç¤ºã€ä¸‹è½½ã€é˜…è¯»ã€ç®¡ç†ç³»ç»Ÿ</p>
                        <h4>ä¸»è¦åŠŸèƒ½</h4>
                        <ul style="text-align: left; margin: 20px 0;">
                            <li>ğŸ” JMå·ç²¾å‡†æœç´¢</li>
                            <li>ğŸ” å…³é”®è¯æ¨¡ç³Šæœç´¢</li>
                            <li>ğŸ“¥ å¼‚æ­¥ä¸‹è½½</li>
                            <li>ğŸ“– åœ¨çº¿é˜…è¯»</li>
                            <li>ğŸ—‘ï¸ æ¼«ç”»ç®¡ç†</li>
                        </ul>
                        <h4>æŠ€æœ¯æ ˆ</h4>
                        <p>Python Flask + JMComic-Crawler-Python</p>
                        <button class="btn btn-primary" onclick="this.closest('.modal').style.display='none'">å…³é—­</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', message);
        }

        // é¡µé¢åŠ è½½å®Œæˆå
        document.addEventListener('DOMContentLoaded', function() {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¡µé¢åˆå§‹åŒ–é€»è¾‘
            console.log('é¦–é¡µåŠ è½½å®Œæˆ');
        });
    </script>
</body>
</html>